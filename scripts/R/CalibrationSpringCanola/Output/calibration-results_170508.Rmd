---
title: "CropSyst calibration - spring canola"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

## Set up script
```{r}
library(ggplot2)
library(plyr)



setwd("C:\\Drive\\Files\\Projects\\FlexCropping\\Methods\\R\\CalibrationSpringCanola")

ggplotRegression <- function(path.obs, path.sim) {
  require(ggplot2)
  require(plyr)
  
  # Read data with observed yield
  df.obs <- read.table(path.obs, sep="\t", header=TRUE)
  
  # Read data with simulated yield, only read required columns
  columnClasses = c("Date", rep("NULL", 10), "numeric", rep("NULL", 70), rep("character", 3), "NULL")
  df.sim <- read.table(path.sim, colClasses = columnClasses, sep="\t", header=TRUE)
  
  # Convert units (from/to?) and extract planting year from date
  df.sim$yield <- df.sim$yield * 10000
  df.sim$Year <- as.numeric(substring(df.sim$planting_date,0,4))
  
  # Merge sim and obs dataframes by location and  year
  df <- merge(df.obs, df.sim, by=c("location", "Year"))
  
  # Rename yield columns for clarity
  df <- rename(df, c("Yield"="yield.obs", "yield"="yield.sim"))
  
  # Graph sim vs obs
  fit <- lm(yield.sim ~ yield.obs, data = df)
  print(summary(fit))
  ggplot(df, aes(x=df$yield.obs, y=df$yield.sim)) + 
    geom_point(shape=1) +
    geom_abline(slope=1) +
    #geom_smooth(method='lm', se=TRUE) +
    stat_smooth(method="lm", formula = y ~ x, size=1) +
    coord_cartesian(xlim=c(0,5000), ylim=c(0,5000)) +
    labs(title = paste("Adj R2 = ",signif(summary(fit)$adj.r.squared, 5),
                       "Intercept =",signif(fit$coef[[1]],5 ),
                       " Slope =",signif(fit$coef[[2]], 5),
                       " P =",signif(summary(fit)$coef[2,4], 5)))
}
```

Original run
```{r}
ggplotRegression("Input\\observed_spring_canola_peas_wheat_planting_dates.txt", "Input\\17-04-21_season_all.dat")
```

